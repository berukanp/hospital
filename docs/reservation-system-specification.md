# 病院予約システム仕様書

## 1. システム概要

### 1.1 システム名
イークリニック予約システム

### 1.2 目的
患者が健康診断の予約をオンラインで行えるシステムを提供し、管理者が予約状況を効率的に管理できるようにする。

### 1.3 対象ユーザー
- **患者**: 健康診断の予約を行う一般ユーザー
- **管理者**: 予約状況の確認・管理を行うクリニックスタッフ

## 2. 機能仕様

### 2.1 認証機能

#### 2.1.1 ユーザーログイン
- **画面**: `/login`
- **機能**: メールアドレスとパスワードによるログイン
- **入力項目**:
  - メールアドレス（必須）
  - パスワード（必須）
- **バリデーション**:
  - 空欄チェック
  - メールアドレス形式チェック
- **処理フロー**:
  1. ユーザーがメールアドレスとパスワードを入力
  2. フロントエンドでバリデーション実行
  3. Supabase Authで認証処理
  4. 認証成功時：
     - 管理者の場合：`/admin`にリダイレクト
     - 一般ユーザーの場合：`/calendar`にリダイレクト
  5. 認証失敗時：エラーメッセージ表示
- **エラーハンドリング**:
  - 入力値が空の場合：「メールアドレスとパスワードを入力してください」
  - 認証失敗の場合：「メールアドレスまたはパスワードが正しくありません」
- **セキュリティ**:
  - パスワードはマスク表示
  - ブルートフォース攻撃対策（Supabase側で実装）

#### 2.1.2 新規ユーザー登録
- **画面**: `/signup`
- **機能**: 新規患者アカウントの作成
- **入力項目**:
  - お名前（必須）
  - お名前カナ（必須）
  - 持っている保険証（必須）
    - 選択肢：国民健康保険、社会保険、共済保険、後期高齢者医療制度、その他
  - 被保険者区分（本人/家族）（必須）
  - 協会けんぽ情報
  - 被保険者証番号
  - 保険者番号
  - 性別（必須）
    - 選択肢：男性、女性
  - 生年月日（必須）
  - 電話番号
  - メールアドレス（必須）
  - 語学力
    - 選択肢：日本語、英語、中国語、韓国語
  - 他の理解できる言語
  - パスワード（必須）
  - パスワード確認（必須）
- **バリデーション**:
  - 必須項目の入力チェック
  - メールアドレス形式チェック
  - パスワード一致チェック
  - 生年月日の妥当性チェック
- **処理フロー**:
  1. ユーザーが全項目を入力
  2. フロントエンドでバリデーション実行
  3. Supabase Authでアカウント作成
  4. usersテーブルとpatientsテーブルにデータ挿入
  5. 自動ログイン処理
  6. `/calendar`にリダイレクト
- **エラーハンドリング**:
  - 必須項目未入力：「必須項目を入力してください」
  - パスワード不一致：「パスワードが一致しません」
  - メールアドレス重複：「このメールアドレスは既に登録されています」

#### 2.1.3 管理者ログイン
- **画面**: `/admin/login`
- **機能**: 管理者専用ログイン
- **認証情報**: admin@example.com / admin123
- **処理フロー**:
  1. 管理者が認証情報を入力
  2. ハードコードされた認証情報と照合
  3. 認証成功時：管理者権限を付与し`/admin`にリダイレクト
  4. 認証失敗時：エラーメッセージ表示
- **セキュリティ**:
  - 管理者専用の認証フロー
  - 一般ユーザーとは分離された権限管理

### 2.2 予約機能

#### 2.2.1 日付選択
- **画面**: `/calendar`
- **機能**: 予約日の選択
- **表示形式**: カレンダー形式（月表示）
- **操作機能**:
  - 前月・翌月ナビゲーション
  - 日付クリックで選択
- **制限事項**:
  - 土日は選択不可
  - 過去の日付は選択不可
  - 当日は選択可能
- **視覚的表示**:
  - 今日の日付：青色の枠線
  - 日曜日：赤色テキスト
  - 土曜日：青色テキスト
  - 選択不可日：グレーアウト
- **処理フロー**:
  1. カレンダー表示
  2. ユーザーが日付をクリック
  3. 選択可能日の場合：注意事項モーダル表示
  4. モーダルでOKクリック：選択日を保存し`/course-selection`へ
  5. 選択不可日の場合：何も起こらない
- **注意事項モーダル**:
  - **タイトル**: 「健康診断のオンライン予約について」
  - **内容**:
    - オンライン予約の説明
    - 予約後の流れ（確認メール送信について）
    - 生活習慣病予防健診の便潜血検査について
    - 検査キット郵送に関する注意事項
    - 2週間前までの予約推奨
  - **操作**: OK/キャンセルボタン
  - 予約後の流れ説明
  - 生活習慣病予防健診の便潜血検査について
  - 確認メール送信について

#### 2.2.2 健診コース選択
- **画面**: `/course-selection`
- **機能**: 健診コースとオプション検査の選択
- **表示情報**:
  - 選択済み日付の表示
  - 健診コース一覧（ラジオボタン形式）
  - オプション検査一覧（チェックボックス形式）
- **健診コース**:
  1. 生活習慣病予防健診（便潜血検査必須）
  2. 定期健診
  3. 法定定期健診
  4. 雇用時健診
  5. 簡易健診
  6. 特定健診
  7. 電離放射線健診
  8. 長時間勤務健診
- **制限事項**:
  - 生活習慣病予防健診は14日以上先の日付のみ選択可能
  - 制限に該当する場合：コース選択不可、警告メッセージ表示
- **処理フロー**:
  1. 健診コース選択
  2. 選択コースに応じてオプション検査の表示更新
  3. 必須オプション（便潜血検査）の自動選択
  4. 「時間選択へ」ボタンクリック
  5. 選択内容を保存し`/time-selection`へ

#### 2.2.3 オプション検査詳細
**A) 臓器がんが気になる方へ**
- 1. 腫瘍マーカー男女共用(4種類) ¥5,610
- 2. 腫瘍マーカー女性用(3種類) ¥4,400
- 3. 腫瘍マーカー女性用(5種類) ¥7,480
- 4. 腫瘍マーカー女性用(6種類) ¥8,910
- 5. 腫瘍マーカー男性用(5種類) ¥7,260
- 6. 腫瘍マーカー男性用(1種類) ¥2,530
- 7. 腫瘍マーカー男女共用(1種類) ¥2,860

**B) 心臓の疾患が気になる方へ**
- 8. 心不全 心臓機能 ¥3,300

**C) 胃・十二指腸の疾患が気になる方へ**
- 9. 胃炎・胃潰瘍 十二指腸潰瘍(ABC分類) ¥4,400

**D) 肝炎感染が気になる方へ**
- 10. B型・C型肝炎 ¥4,400

**E) HIV感染が気になる方へ**
- 11. HIV感染 ¥2,200

**F) 甲状腺の疾患が気になる方へ**
- 12. 甲状腺疾患 ¥4,510

**G) リウマチ疾患が気になる方へ**
- 13. リウマチ疾患 ¥4,510

**H) アレルギーが気になる方へ**
- 14. アレルギー (View 39) ¥17,600
- 15. アレルギー (吸入系アレルギー6種類) ¥7,810

**I) 認知症が気になる方へ (要予約)**
- 16. 認知症(アルツハイマー) MCIスクリーニング ¥30,000
- 17. 認知症(アルツハイマー) APOE遺伝子 ¥30,000

**その他 オプション検査**
- 18. 動脈硬化 ABI検査 ¥1,450
- 19. 骨密度検査 ¥1,650
- 20. 血液型検査 ¥2,000
- 21. 胃部レントゲン検査 ¥10,450
- 22. 腹部エコー(要予約) ¥6,050
- 23. 頸部エコー(要予約) ¥2,200
- 24. 眼底検査 ¥2,050
- 25. 便潜血検査(要予約) ¥1,650
- 26. 便培養検査(要予約) ¥2,000

**制限事項**:
- 便潜血検査は14日以上先の日付のみ選択可能
- 制限に該当する場合：選択不可、警告メッセージ表示
- 生活習慣病予防健診選択時：便潜血検査は自動選択（必須）

#### 2.2.4 時間選択
- **画面**: `/time-selection`
- **機能**: 予約時間の選択
- **表示情報**:
  - 選択済み日付と健診コースの表示
  - 時間帯別の時間枠一覧
- **時間帯**:
  - **午前**: 09:00, 09:30, 10:00, 10:30, 11:00, 11:30
  - **午後**: 15:30, 16:00, 16:30
- **表示形式**:
  - 午前・午後でセクション分け
  - 各時間枠をボタン形式で表示
  - 選択可能時間は青色背景
- **処理フロー**:
  1. 時間枠一覧表示
  2. ユーザーが時間をクリック
  3. 選択時間を保存し`/reservation-input`へ
- **制限事項**:
  - 既に予約済みの時間枠は選択不可（将来実装予定）

#### 2.2.5 予約情報入力
- **画面**: `/reservation-input`
- **機能**: 会社名の入力
- **表示情報**:
  - 選択済み日付、時間、健診コースの表示
- **入力項目**:
  - 会社名（必須）※個人の場合は「個人」と入力
- **バリデーション**:
  - 会社名の必須チェック
  - 空欄の場合：「会社名は必須です」エラー表示
- **処理フロー**:
  1. 会社名入力
  2. 「予約確認画面へ」ボタンクリック
  3. バリデーション実行
  4. 成功時：入力内容を保存し`/reservation-confirmation`へ

#### 2.2.6 予約者情報確認
- **画面**: `/reservation-confirmation`
- **機能**: 予約内容と予約者情報の確認・編集
- **表示項目**:
  - 日付
  - 時間
  - 健診コース
  - 会社名
  - オプション検査（選択した場合のみ）
- **予約者情報**:
  - お名前（必須）
  - 電話番号（必須）
  - 住所（必須）
  - メールアドレス（必須）
- **機能**:
  - ユーザー登録データの自動入力
  - 情報変更時のユーザーデータ更新
- **バリデーション**:
  - 全項目の必須チェック
  - メールアドレス形式チェック
- **処理フロー**:
  1. 予約内容と予約者情報表示
  2. 必要に応じて予約者情報を編集
  3. 「予約を確定する」ボタンクリック
  4. バリデーション実行
  5. 成功時：予約データを保存し`/reservation-complete`へ
  6. 変更された予約者情報はユーザーデータも更新

#### 2.2.7 予約完了
- **画面**: `/reservation-complete`
- **機能**: 予約完了の表示
- **表示内容**:
  - 予約完了メッセージ
  - 成功アイコン（緑色のチェックマーク）
  - 予約日時
  - 予約者情報
- **操作**:
  - 「マイ予約へ」ボタン：`/my-reservations`へ遷移
- **処理フロー**:
  1. 予約完了画面表示
  2. 予約データをマイ予約リストに追加
  3. 予約フォームデータをリセット

### 2.3 予約管理機能

#### 2.3.1 マイ予約
- **画面**: `/my-reservations`
- **機能**: 自分の予約一覧表示
- **表示項目**:
  - 予約日時
  - 健診コース
  - オプション検査
  - 予約状況
- **表示形式**:
  - カード形式で各予約を表示
  - 予約がない場合：「予約がありません」メッセージ
- **操作**:
  - 予約キャンセル
  - 新しい予約を登録する
- **処理フロー**:
  1. 予約一覧表示
  2. キャンセルボタンクリック
  3. 確認ダイアログ表示
  4. 確認時：予約をリストから削除
- **制限事項**:
  - 現在はキャンセルのみ対応（変更機能は将来実装予定）

#### 2.3.2 プロフィール編集
- **画面**: `/profile`
- **機能**: 登録情報の編集
- **編集可能項目**: 新規登録時と同じ項目
- **処理フロー**:
  1. 現在の登録情報を表示
  2. ユーザーが情報を編集
  3. 「更新する」ボタンクリック
  4. バリデーション実行
  5. 成功時：ユーザーデータを更新し前画面へ戻る
- **バリデーション**:
  - 新規登録時と同じバリデーションルール適用

### 2.4 管理者機能

#### 2.4.1 管理者ダッシュボード
- **画面**: `/admin`
- **機能**: 予約状況の概要表示
- **表示内容**:
  - カレンダー形式の予約状況
    - 各日付に予約件数表示
    - 予約がある日は予約者名と時間を表示
  - 本日の予約一覧（午前・午後別）
    - 時間順でソート表示
    - 予約者名、時間、ステータス表示
- **操作機能**:
  - 月次ナビゲーション
  - 新規予約追加ボタン
- **レイアウト**:
  - 左側：管理者専用メニュー
  - 右側：メインコンテンツエリア

#### 2.4.2 予約一覧管理
- **画面**: `/admin/reservations`
- **機能**: 全予約の一覧表示
- **表示項目**:
  - 予約日時
  - 予約者情報
    - 名前、電話番号、メールアドレス
  - 健診コース
  - オプション検査
  - 会社名
  - 予約ステータス
- **表示形式**:
  - カード形式で詳細情報を表示
  - 予約がない場合：「予約がありません」メッセージ
- **操作機能**:
  - 予約詳細表示
  - ステータス変更（将来実装予定）
- **ソート・フィルタ**:
  - 日付順ソート
  - ステータス別フィルタ（将来実装予定）

#### 2.4.3 患者情報管理
- **画面**: `/admin/users`
- **機能**: 登録患者の一覧表示
- **表示項目**:
  - 名前
  - メールアドレス
  - 電話番号
  - 保険種別
  - 登録日
- **表示形式**:
  - テーブル形式で一覧表示
  - ページネーション（将来実装予定）
- **操作機能**:
  - 患者詳細表示（将来実装予定）
  - 患者情報編集（将来実装予定）
- **検索・フィルタ**:
  - 名前検索（将来実装予定）
  - 登録日範囲指定（将来実装予定）

### 2.5 共通機能

#### 2.5.1 ナビゲーション
- **ヘッダー**:
  - システム名表示
  - ユーザー向けメニュー：登録情報、マイ予約、ログアウト
  - 管理者向けメニュー：ログアウトのみ
- **認証ガード**:
  - 未認証ユーザーは自動的にログイン画面へリダイレクト
  - 管理者権限が必要な画面は権限チェック実行

#### 2.5.2 エラーハンドリング
- **バリデーションエラー**:
  - 入力フィールド下に赤色でエラーメッセージ表示
  - エラーがあるフィールドは赤色の枠線表示
- **システムエラー**:
  - ネットワークエラー時の適切なメッセージ表示
  - データベースエラー時の適切なメッセージ表示
- **404エラー**:
  - 存在しないページへのアクセス時はログイン画面へリダイレクト

#### 2.5.3 レスポンシブデザイン
- **モバイル対応**:
  - スマートフォンでの操作性を考慮したUI
  - タッチ操作に適したボタンサイズ
- **タブレット対応**:
  - 中間サイズでの表示最適化
- **デスクトップ対応**:
  - 大画面での情報表示最適化

## 3. 技術仕様

### 3.1 フロントエンド
- **フレームワーク**: React 18.3.1
- **ルーティング**: React Router DOM 6.22.3
- **スタイリング**: Tailwind CSS 3.4.1
- **アイコン**: Lucide React 0.344.0
- **ビルドツール**: Vite 5.4.2

### 3.2 バックエンド
- **データベース**: Supabase
- **認証**: Supabase Auth
- **API**: Supabase JavaScript Client 2.39.7

### 3.3 デプロイメント
- **ホスティング**: Netlify
- **ビルドコマンド**: `npm run build`
- **出力ディレクトリ**: `dist`

## 4. データベース設計

### 4.1 主要テーブル
- **users**: ユーザー基本情報
- **patients**: 患者固有情報
- **courses**: 健診コース
- **time_slots_master**: 時間枠マスタ
- **appointments**: 予約情報
- **facility_settings**: 施設設定
- **default_closure_rules**: 定期休診ルール
- **special_closure_days**: 特別休診日

## 5. セキュリティ

### 5.1 認証・認可
- Supabase Authによるユーザー認証
- Row Level Security (RLS) による行レベルセキュリティ
- 管理者権限の分離

### 5.2 データ保護
- 個人情報の暗号化
- HTTPS通信の強制
- セッション管理

## 6. 運用・保守

### 6.1 バックアップ
- Supabaseによる自動バックアップ
- 定期的なデータエクスポート

### 6.2 監視
- エラーログの監視
- パフォーマンス監視
- セキュリティ監視

## 7. 今後の拡張予定

### 7.1 機能拡張
- メール通知機能
- SMS通知機能
- 予約変更機能
- 支払い機能

### 7.2 システム改善
- パフォーマンス最適化
- UI/UX改善
- モバイルアプリ対応

---

**作成日**: 2024年12月
**バージョン**: 1.0
**作成者**: システム開発チーム